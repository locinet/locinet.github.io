---
layout: layout.njk
pageTitle: "Locinet — Loci Theologici"
navExtra: '<div class="add-author-container"><a href="#" class="contribute-link" id="add-author-btn">Add an author</a><div class="add-author-dropdown" id="add-author-dropdown" style="display:none;"><input type="text" id="author-search" placeholder="Search Wikidata for a person..." autocomplete="off"><div class="author-search-status" id="author-search-status"></div><ul class="author-search-results" id="author-search-results"></ul></div></div>'
---

<h1>Loci Theologici</h1>

<div class="view-toggle">
  <button type="button" class="toggle-btn active" id="toggle-topic">By Topic</button>
  <button type="button" class="toggle-btn" id="toggle-author">By Author</button>
  <div class="tradition-dropdown" id="tradition-dropdown">
    <button type="button" class="tradition-dropdown-btn" id="tradition-dropdown-btn">All traditions</button>
    <div class="tradition-dropdown-menu" id="tradition-dropdown-menu" style="display:none;">
      {% for t in site.traditions %}
        <label class="tradition-option">
          <input type="checkbox" value="{{ t.slug }}" class="tradition-checkbox"> {{ t.name }}
        </label>
      {% endfor %}
    </div>
  </div>
</div>

<div class="filter-box" id="filter-box-topic">
  <label for="loci-filter">Filter by locus:</label>
  <input type="text" id="loci-filter" placeholder="Type to filter..." autocomplete="off">
  <button type="button" id="clear-filter" class="clear-btn">Clear</button>
</div>

<div class="filter-box" id="filter-box-author" style="display:none;">
  <label for="author-filter">Filter by author:</label>
  <input type="text" id="author-filter" placeholder="Type to filter..." autocomplete="off">
  <button type="button" id="clear-author-filter" class="clear-btn">Clear</button>
  <span class="active-locus-indicator" id="active-locus-indicator" style="display:none;">
    <span id="active-locus-name"></span>
    <button type="button" class="clear-locus-btn" id="clear-locus-filter">&times;</button>
  </span>
</div>

<div class="loci-page">

<nav class="loci-sidebar">
{% macro renderSidebarChildren(nodes, depth) %}
<ul class="stree{% if depth >= 1 %} stree-collapsed{% endif %}">
  {% for node in nodes %}
  <li>
    {% if node.children and depth >= 1 %}
    <a href="#locus-{{ node.slug }}" class="stree-toggle" data-slug="{{ node.slug }}">{{ node.name }}</a>
    {% else %}
    <a href="#locus-{{ node.slug }}" data-slug="{{ node.slug }}">{{ node.name }}</a>
    {% endif %}
    {% if node.children %}{{ renderSidebarChildren(node.children, depth + 1) }}{% endif %}
  </li>
  {% endfor %}
</ul>
{% endmacro %}
<ul class="stree stree-root">
  {% for node in site.lociTree %}
  <li>
    <a href="#locus-{{ node.slug }}" class="stree-top{% if node.children %} stree-toggle{% endif %}" data-slug="{{ node.slug }}">{{ node.name }}</a>
    {% if node.children %}{{ renderSidebarChildren(node.children, 1) }}{% endif %}
  </li>
  {% endfor %}
</ul>
</nav>

<div class="loci-main">
<div id="loci-tree" class="loci-tree">
{% macro renderNode(node, depth) %}
  {% set lociEntry = site.lociIndex[node.slug] %}
  {% set authorList = [] %}
  {% if lociEntry %}
    {% for qid, authorData in lociEntry %}
      {% set authorList = (authorList.push(authorData), authorList) %}
    {% endfor %}
  {% endif %}

  <div class="loci-node" id="locus-{{ node.slug }}" data-slug="{{ node.slug }}" data-depth="{{ depth }}">
    <span class="loci-name">{{ node.name }}</span>
    <span class="loci-slug-label">({{ node.slug }})</span>
    {% if authorList.length > 0 %}
      <span class="loci-authors">
        <span class="loci-authors-dash">— </span>{% for author in authorList %}<span class="loci-author-item" data-tradition="{{ author.tradition }}"><a href="/authors/{{ author.slug }}/?locus={{ node.slug }}"
             class="author-link"
             data-entries="{{ author.entries | dump | escape }}">{{ author.displayName }}</a></span>{% endfor %}
      </span>
    {% endif %}

    {% if node.children %}
      <div class="loci-children">
        {% for child in node.children %}
          {{ renderNode(child, depth + 1) }}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endmacro %}

{% for node in site.lociTree %}
  {{ renderNode(node, 0) }}
{% endfor %}
</div>
</div>

<div class="works-main" style="display:none;">
<div id="works-index">
{% for author in site.worksIndex %}
  <div class="works-index-author" data-author-name="{{ author.name | lower }}" data-tradition="{{ author.tradition }}">
    <h2>
      <a href="/authors/{{ author.slug }}/">{{ author.name }}</a>
      {% if author.birthYear or author.deathYear %}
        <span class="author-dates-inline">({% if author.birthYear %}{{ author.birthYear }}{% endif %}{% if author.deathYear %}–{{ author.deathYear }}{% endif %})</span>
      {% endif %}
    </h2>
    <ul class="works-index-list">
      {% for work in author.works %}
        <li data-loci="{{ work.allLoci | dump | escape }}">
          {% if work.year %}<span class="work-year">{{ work.year }}.</span> {% endif %}<a href="/authors/{{ author.slug }}/#{{ work.id }}" class="work-title-inline">{{ work.title }}</a>{% if work.origTitle and work.origTitle != work.title %} <em class="work-orig-inline">({{ work.origTitle }})</em>{% endif %}{% if work.oclc %} <a href="https://www.worldcat.org/oclc/{{ work.oclc }}" class="oclc-link" title="WorldCat">[WorldCat]</a>{% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endfor %}
</div>
</div>

</div>

<div class="author-tooltip" id="author-tooltip" style="display:none;"></div>

<script>
  const lociFlat = {{ site.lociFlat | dump | safe }};
  const traditions = {{ site.traditions | dump | safe }};
</script>
<script>
  // Tooltip for author mouseover
  (function() {
    const tooltip = document.getElementById('author-tooltip');
    document.querySelectorAll('.author-link').forEach(link => {
      link.addEventListener('mouseenter', function(e) {
        try {
          const entries = JSON.parse(this.dataset.entries);
          let html = '<ul>';
          for (const entry of entries) {
            html += '<li>' + escapeHtml(entry.workTitle);
            if (entry.sectionTitle) html += ' — ' + escapeHtml(entry.sectionTitle);
            html += '</li>';
          }
          html += '</ul>';
          tooltip.innerHTML = html;
          tooltip.style.display = 'block';
          positionTooltip(e);
        } catch(err) {}
      });
      link.addEventListener('mousemove', positionTooltip);
      link.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
    });

    function positionTooltip(e) {
      tooltip.style.left = (e.pageX + 12) + 'px';
      tooltip.style.top = (e.pageY + 12) + 'px';
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
  })();
</script>

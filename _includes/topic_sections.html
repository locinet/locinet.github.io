{% comment %}
This include displays sections for a given topic_id with tooltips
Uses new data structure: works/, structures/, titles/, links/
Parameters: topic_id
{% endcomment %}

{% assign sections_found = false %}
{% assign work_sections = "" | split: "" %}

{% comment %} Iterate through all topics assignment files {% endcomment %}
{% for data_file in site.data %}
  {% assign file_name = data_file[0] %}
  {% assign file_data = data_file[1] %}
  
  {% if file_name contains "_topics" %}
    {% assign work_id = file_data.work_id %}
    
    {% comment %} Get work metadata {% endcomment %}
    {% assign work_file_name = "works/" | append: work_id %}
    {% assign work = site.data[work_file_name] %}
    
    {% if work %}
      {% comment %} Process assignments {% endcomment %}
      {% for assignment in file_data.assignments %}
        {% if assignment.topics contains include.topic_id %}
          {% assign section_id = assignment.section_id %}
          
          {% comment %} Get structure info to find parent and ordinal {% endcomment %}
          {% assign structure_file_name = "structures/" | append: work_id %}
          {% assign structure_data = site.data[structure_file_name] %}
          
          {% if structure_data %}
            {% for node in structure_data.structure.nodes %}
              {% if node.id == section_id %}
                {% assign parent_id = node.parent %}
                {% assign ordinal = node.ordinal %}
                
                {% comment %} Find parent ordinal if exists {% endcomment %}
                {% assign parent_ordinal = "" %}
                {% for parent_node in structure_data.structure.nodes %}
                  {% if parent_node.id == parent_id %}
                    {% assign parent_ordinal = parent_node.ordinal %}
                  {% endif %}
                {% endfor %}
                
                {% comment %} Get first link {% endcomment %}
                {% assign first_link = "" %}
                {% assign links_file_name = "links/" | append: work_id %}
                {% assign links_data = site.data[links_file_name] %}
                {% if links_data and links_data.sites %}
                  {% for site_entry in links_data.sites %}
                    {% assign site_name = site_entry[0] %}
                    {% assign site_data = site_entry[1] %}
                    {% if site_data.nodes[section_id] %}
                      {% assign first_link = site_data.nodes[section_id] %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                
                {% capture section_data %}{{ work.id }}|{{ work.author }}|{{ work.short_title }}|{{ work.title }}|{{ work.year }}|{{ parent_ordinal }}|{{ ordinal }}|{{ first_link }}{% endcapture %}
                {% assign work_sections = work_sections | push: section_data %}
                {% assign sections_found = true %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if sections_found %}
  {% assign works_hash = "" | split: "" %}
  
  {% for section_data in work_sections %}
    {% assign parts = section_data | split: "|" %}
    {% assign work_id = parts[0] %}
    
    {% assign work_found = false %}
    {% for existing_work in works_hash %}
      {% if existing_work == work_id %}
        {% assign work_found = true %}
      {% endif %}
    {% endfor %}
    
    {% unless work_found %}
      {% assign works_hash = works_hash | push: work_id %}
    {% endunless %}
  {% endfor %}
  
  {% for work_id in works_hash %}
    {% assign work_data = "" | split: "" %}
    {% assign author_id = "" %}
    {% assign work_short_title = "" %}
    {% assign work_full_title = "" %}
    {% assign work_year = "" %}
    
    {% for section_data in work_sections %}
      {% assign parts = section_data | split: "|" %}
      {% if parts[0] == work_id %}
        {% assign work_data = work_data | push: section_data %}
        {% assign author_id = parts[1] %}
        {% assign work_short_title = parts[2] %}
        {% assign work_full_title = parts[3] %}
        {% assign work_year = parts[4] %}
      {% endif %}
    {% endfor %}
    
    {% assign sorted_data = work_data | sort %}
    
    {% assign author_short_name = "" %}
    {% assign author_full_name = "" %}
    {% assign author_tradition = "" %}
    {% for author in site.data.authors.authors %}
      {% if author.id == author_id %}
        {% assign author_short_name = author.short_name %}
        {% assign author_full_name = author.name.en %}
        {% assign author_tradition = author.tradition %}
      {% endif %}
    {% endfor %}
    
    {% assign work_url = "" %}
    {% for work_page in site.works %}
      {% if work_page.work_id == work_id %}
        {% assign work_url = work_page.url %}
      {% endif %}
    {% endfor %}
    
    {% assign current_book = -1 %}
    {% assign range_start = -1 %}
    {% assign range_end = -1 %}
    {% assign ranges = "" %}
    {% assign first_link = "" %}
    
    {% for section_data in sorted_data %}
      {% assign parts = section_data | split: "|" %}
      {% assign book_num = parts[5] | plus: 0 %}
      {% assign chapter_num = parts[6] | plus: 0 %}
      {% assign link_url = parts[7] %}
      
      {% if current_book == -1 or current_book != book_num %}
        {% if range_start != -1 %}
          {% if ranges != "" %}
            {% assign ranges = ranges | append: ", " %}
          {% endif %}
          {% if range_start == range_end %}
            {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
          {% else %}
            {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
          {% endif %}
        {% endif %}
        
        {% assign current_book = book_num %}
        {% assign range_start = chapter_num %}
        {% assign range_end = chapter_num %}
        {% assign first_link = link_url %}
      {% else %}
        {% assign expected = range_end | plus: 1 %}
        {% if chapter_num == expected %}
          {% assign range_end = chapter_num %}
        {% else %}
          {% if ranges != "" %}
            {% assign ranges = ranges | append: ", " %}
          {% endif %}
          {% if range_start == range_end %}
            {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
          {% else %}
            {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
          {% endif %}
          
          {% assign range_start = chapter_num %}
          {% assign range_end = chapter_num %}
          {% assign first_link = link_url %}
        {% endif %}
      {% endif %}
    {% endfor %}
    
    {% if range_start != -1 %}
      {% if ranges != "" %}
        {% assign ranges = ranges | append: ", " %}
      {% endif %}
      {% if range_start == range_end %}
        {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
      {% else %}
        {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
      {% endif %}
    {% endif %}
    
    <span class="section-reference">
      <span class="author-name" title="{{ author_full_name }} ({{ author_tradition }})">{{ author_short_name }}</span>
      {% if work_url != "" %}
        <a href="{{ work_url | relative_url }}" class="work-title" title="{{ work_full_title }} ({{ work_year }})">{{ work_short_title }}</a>
      {% else %}
        <span class="work-title" title="{{ work_full_title }} ({{ work_year }})">{{ work_short_title }}</span>
      {% endif %}
      {{ ranges }}
    </span>
    {% unless forloop.last %}<span class="section-separator"> â€¢ </span>{% endunless %}
  {% endfor %}
{% else %}
  <p class="no-sections">No sections tagged with this topic yet</p>
{% endif %}

{% comment %}
This include displays sections for a given topic_id
Parameters: topic_id
Works with any work that has a corresponding work_topics.yaml file
{% endcomment %}

{% assign sections_found = false %}
{% assign work_sections = "" | split: "" %}

{% comment %} Iterate through all data files to find work_topics files {% endcomment %}
{% for data_file in site.data %}
  {% assign file_name = data_file[0] %}
  {% assign file_data = data_file[1] %}
  
  {% comment %} Check if this is a topics file (ends with _topics) {% endcomment %}
  {% if file_name contains "_topics" %}
    {% assign work_id = file_data.work_id %}
    
    {% comment %} Get the corresponding work file name {% endcomment %}
    {% assign work_file_name = file_name | remove: "_topics" %}
    {% assign work_file = site.data[work_file_name] %}
    
    {% if work_file and work_file.works %}
      {% comment %} Process assignments from this topics file {% endcomment %}
      {% for assignment in file_data.assignments %}
        {% if assignment.topics contains include.topic_id %}
          {% for work in work_file.works %}
            {% if work.id == work_id %}
              {% comment %} Handle different structure types {% endcomment %}
              {% for structure_item in work.structure %}
                {% comment %} Check if this has chapters (like Institutes) {% endcomment %}
                {% if structure_item.children %}
                  {% for child in structure_item.children %}
                    {% if child.id == assignment.section_id %}
                      {% assign first_link = "" %}
                      {% if child.links.size > 0 %}
                        {% assign first_link = child.links[0].url %}
                      {% endif %}
                      {% capture section_data %}{{ work.id }}|{{ work.author }}|{{ work.short_title }}|{{ structure_item.number }}|{{ child.number }}|{{ first_link }}{% endcapture %}
                      {% assign work_sections = work_sections | push: section_data %}
                      {% assign sections_found = true %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if sections_found %}
  {% comment %} Group sections by work {% endcomment %}
  {% assign works_hash = "" | split: "" %}
  
  {% for section_data in work_sections %}
    {% assign parts = section_data | split: "|" %}
    {% assign work_id = parts[0] %}
    
    {% assign work_found = false %}
    {% for existing_work in works_hash %}
      {% if existing_work == work_id %}
        {% assign work_found = true %}
      {% endif %}
    {% endfor %}
    
    {% unless work_found %}
      {% assign works_hash = works_hash | push: work_id %}
    {% endunless %}
  {% endfor %}
  
  <ul class="sections-list">
    {% for work_id in works_hash %}
      {% comment %} Get all sections for this work {% endcomment %}
      {% assign work_data = "" | split: "" %}
      {% assign author_id = "" %}
      {% assign work_title = "" %}
      
      {% for section_data in work_sections %}
        {% assign parts = section_data | split: "|" %}
        {% if parts[0] == work_id %}
          {% assign work_data = work_data | push: section_data %}
          {% assign author_id = parts[1] %}
          {% assign work_title = parts[2] %}
        {% endif %}
      {% endfor %}
      
      {% comment %} Sort sections by book and chapter {% endcomment %}
      {% assign sorted_data = work_data | sort %}
      
      {% comment %} Get author short name {% endcomment %}
      {% assign author_name = "" %}
      {% for author in site.data.authors.authors %}
        {% if author.id == author_id %}
          {% assign author_name = author.short_name %}
        {% endif %}
      {% endfor %}
      
      {% comment %} Build ranges {% endcomment %}
      {% assign current_book = -1 %}
      {% assign range_start = -1 %}
      {% assign range_end = -1 %}
      {% assign ranges = "" %}
      {% assign first_link = "" %}
      
      {% for section_data in sorted_data %}
        {% assign parts = section_data | split: "|" %}
        {% assign book_num = parts[3] | plus: 0 %}
        {% assign chapter_num = parts[4] | plus: 0 %}
        {% assign link_url = parts[5] %}
        
        {% if current_book == -1 or current_book != book_num %}
          {% comment %} New book - save previous range {% endcomment %}
          {% if range_start != -1 %}
            {% if ranges != "" %}
              {% assign ranges = ranges | append: ", " %}
            {% endif %}
            {% if range_start == range_end %}
              {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
            {% else %}
              {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
            {% endif %}
          {% endif %}
          
          {% assign current_book = book_num %}
          {% assign range_start = chapter_num %}
          {% assign range_end = chapter_num %}
          {% assign first_link = link_url %}
        {% else %}
          {% comment %} Same book - check if contiguous {% endcomment %}
          {% assign expected = range_end | plus: 1 %}
          {% if chapter_num == expected %}
            {% assign range_end = chapter_num %}
          {% else %}
            {% comment %} Gap - save previous range and start new one {% endcomment %}
            {% if ranges != "" %}
              {% assign ranges = ranges | append: ", " %}
            {% endif %}
            {% if range_start == range_end %}
              {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
            {% else %}
              {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
            {% endif %}
            
            {% assign range_start = chapter_num %}
            {% assign range_end = chapter_num %}
            {% assign first_link = link_url %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% comment %} Save final range {% endcomment %}
      {% if range_start != -1 %}
        {% if ranges != "" %}
          {% assign ranges = ranges | append: ", " %}
        {% endif %}
        {% if range_start == range_end %}
          {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '</a>' %}
        {% else %}
          {% assign ranges = ranges | append: '<a href="' | append: first_link | append: '" target="_blank">' | append: current_book | append: '.' | append: range_start | append: '-' | append: range_end | append: '</a>' %}
        {% endif %}
      {% endif %}
      
      <li class="section-item">
        <div class="section-reference">
          {{ author_name }} {{ work_title }} {{ ranges }}
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="no-sections">No sections tagged with this topic yet</p>
{% endif %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title }} - {{ site.title }}</title>
  <style>
    body { max-width: 800px; margin: 2rem auto; line-height: 1.6; }
    a { color: blue; text-decoration: none; }
    h1,h2,h3 { margin-top: 1.5em; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 0.5em; }
  </style>
</head>
<body>
  <header>
    <h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
  </header>
  <main>
{% assign work = nil %}
{% for pair in site.data %}
  {% if pair[1].works %}
    {% for w in pair[1].works %}
      {% if w.id == page.work_id %}
        {% assign work = w %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% if work == nil %}
  <p>Work not found.</p>
{% else %}
<h1><em>{{ work.title }}</em></h1>
<p>
  <strong>{{ work.author }}</strong>
  {% if work.year %} ({{ work.year }}){% endif %}
</p>

{% for item in work.structure %}
  <h2>{{ item.type | capitalize }} {{ item.number }}: {{ item.title.en }}</h2>
  {% if item.children %}
    <ul>
      {% for child in item.children %}
  <li>
    {{ child.type | capitalize }} {{ child.number }} —
    {{ child.title.en }}

    {% if child.links %}
      {% for link in child.links %}
         — <a href="{{ link.url }}" target="_blank">{{ link.site }}</a>
      {% endfor %}
    {% endif %}
    
    {% comment %}Find topics for this section{% endcomment %}
      {% comment %}Check all topic files{% endcomment %}
      {% assign section_assignment = nil %}
      {% if site.data.topics.assignments %}
        {% assign section_assignment = site.data.topics.assignments | where: "section_id", child.id | first %}
      {% endif %}
      {% unless section_assignment %}
        {% if site.data.institutes_topics.assignments %}
          {% assign section_assignment = site.data.institutes_topics.assignments | where: "section_id", child.id | first %}
        {% endif %}
      {% endunless %}
      {% unless section_assignment %}
        {% if site.data.summa_first_part_topics.assignments %}
          {% assign section_assignment = site.data.summa_first_part_topics.assignments | where: "section_id", child.id | first %}
        {% endif %}
      {% endunless %}

{% if section_assignment and section_assignment.topics.size > 0 %}
  <br>
  <small>Topics: 
    {% for topic_id in section_assignment.topics %}
      {% comment %}Find topic name from hierarchy{% endcomment %}
      {% assign topic_def = topic_lookup | where: "id", topic_id | first %}
      {% if topic_def %}
        <a href="{{ '/topics/#' | append: topic_id | relative_url }}" class="topic-tag">
          {{ topic_def.name }}
        </a>
      {% endif %}
    {% endfor %}
  </small>
{% endif %}

  </li>
{% endfor %}
    </ul>
  {% endif %}
{% endfor %}
{% endif %}
  </main>
</body>
</html>


